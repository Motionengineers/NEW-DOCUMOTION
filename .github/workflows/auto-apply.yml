name: Auto-Apply Scheduled Job

on:
  schedule:
    # Run daily at 9 AM IST (3:30 AM UTC)
    - cron: '30 3 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  auto-apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run auto-apply
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: production
        run: |
          node -e "
          const { processAllEligibleStartups } = require('./lib/autoApplyEngine');
          processAllEligibleStartups({ maxStartups: 100, onlyEnabled: true })
            .then(results => {
              console.log('Processing completed:', results);
              process.exit(results.failed > 0 ? 1 : 0);
            })
            .catch(error => {
              console.error('Error:', error);
              process.exit(1);
            });
          "

      - name: Send notification (optional)
        if: failure()
        run: |
          echo "Auto-apply job failed. Check logs for details."
