generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AppConfig {
  id               String   @id @default(cuid())
  openaiKey        String?
  cloudName        String?
  cloudKey         String?
  cloudSecret      String?
  storageProvider  String?  @default("cloudinary")
  razorpayId       String?
  razorpaySecret   String?
  brandColor       String?
  brandLogo        String?
  brandName        String?
  brandDescription String?
  founderName      String?
  freeMode         Boolean  @default(true)
  completed        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ==== Talent Database (MVP) ====
model Talent {
  id           Int       @id @default(autoincrement())
  userId       Int?
  fullName     String
  email        String    @unique
  phone        String?
  location     String?
  timezone     String?
  bio          String?
  designation  String?   // JobTitle/role e.g., CEO, Founder, CTO
  industry     String?   // Company name
  yearsExp     Int?      // total experience in years
  rateHourly   Float?
  rateDaily    Float?
  currency     String?   // e.g., INR, USD
  status       String    @default("active") // active | inactive | archived
  photoUrl     String?
  linkedinUrl  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user         User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  skills       TalentSkill[]
  experiences  Experience[]
  educations   Education[]
  certifications Certification[]
  portfolios   PortfolioItem[]
  assignments  Assignment[]
  feedbacks    Feedback[]
}

model Skill {
  id        Int      @id @default(autoincrement())
  key       String   @unique // normalized key e.g., javascript, react
  label     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  talents   TalentSkill[]
  roleRequirements RoleRequirement[]
}

model TalentSkill {
  talentId   Int
  skillId    Int
  level      Int?     // 1-5 proficiency
  lastUsedAt DateTime?

  talent     Talent   @relation(fields: [talentId], references: [id], onDelete: Cascade)
  skill      Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@id([talentId, skillId])
  @@index([skillId])
}

model Experience {
  id          Int      @id @default(autoincrement())
  talentId    Int
  company     String
  title       String
  startDate   DateTime
  endDate     DateTime?
  description String?

  talent      Talent   @relation(fields: [talentId], references: [id], onDelete: Cascade)
}

model Education {
  id          Int      @id @default(autoincrement())
  talentId    Int
  institution String
  degree      String?
  startDate   DateTime?
  endDate     DateTime?

  talent      Talent   @relation(fields: [talentId], references: [id], onDelete: Cascade)
}

model Certification {
  id          Int      @id @default(autoincrement())
  talentId    Int
  name        String
  issuer      String?
  issuedAt    DateTime?
  expiresAt   DateTime?

  talent      Talent   @relation(fields: [talentId], references: [id], onDelete: Cascade)
}

model PortfolioItem {
  id          Int      @id @default(autoincrement())
  talentId    Int
  title       String
  url         String?
  mediaType   String?  // image | video | doc | link
  description String?

  talent      Talent   @relation(fields: [talentId], references: [id], onDelete: Cascade)
}

model Role {
  id           Int      @id @default(autoincrement())
  title        String
  description  String?
  locationReq  String?  // remote | onsite | hybrid | city
  rateMin      Float?
  rateMax      Float?
  currency     String?
  experienceLv String?  // junior | mid | senior
  status       String   @default("open") // open | assigned | completed
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  requirements RoleRequirement[]
  assignments  Assignment[]
  feedbacks    Feedback[]
}

model RoleRequirement {
  id       Int   @id @default(autoincrement())
  roleId   Int
  skillId  Int
  level    Int?  // desired proficiency
  weight   Int?  // importance weight 1-5

  role     Role  @relation(fields: [roleId], references: [id], onDelete: Cascade)
  skill    Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@index([roleId])
  @@index([skillId])
}

model Assignment {
  id         Int      @id @default(autoincrement())
  talentId   Int
  roleId     Int
  startDate  DateTime?
  endDate    DateTime?
  status     String   @default("active") // active | completed | cancelled
  notes      String?

  talent     Talent   @relation(fields: [talentId], references: [id], onDelete: Cascade)
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
}

model Feedback {
  id         Int      @id @default(autoincrement())
  talentId   Int
  roleId     Int?
  rating     Int      // 1-5
  comment    String?
  createdAt  DateTime @default(now())

  talent     Talent   @relation(fields: [talentId], references: [id], onDelete: Cascade)
  role       Role?    @relation(fields: [roleId], references: [id], onDelete: SetNull)
}

model User {
  id                Int                @id @default(autoincrement())
  email             String             @unique
  name              String?
  passwordHash      String?
  role              String             @default("founder")
  teamRole          String             @default("VIEWER")
  status            String             @default("ACTIVE")
  agencyId          Int?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  emailVerified     DateTime?
  image             String?
  accounts          Account[]
  maListings        MAListing[]
  marketingRequests MarketingRequest[]
  sessions          Session[]
  startups          Startup[]
  talents           Talent[]
  agency            Agency?            @relation("AgencyMembers", fields: [agencyId], references: [id], onDelete: SetNull)
  invitationsCreated TeamInvitation[]  @relation("InvitesCreated")
  invitationsAccepted TeamInvitation[] @relation("InvitesAccepted")
  feedPosts         FeedPost[]
  feedInteractions  FeedInteraction[]
  feedComments      FeedComment[]
  feedFollowing     FeedFollow[]        @relation("FeedFollowFollower")
  feedFollowers     FeedFollow[]        @relation("FeedFollowTargetUser")
  feedBookmarks     FeedBookmark[]
  feedNotifications FeedNotification[]
  feedTopicPreferences FeedTopicPreference[]
  fundingApplications FundingApplication[] @relation("ApplicantApplications")
  fundingReviews    FundingApplication[] @relation("ReviewerApplications")
  fundingActivities FundingApplicationActivity[]
  portalOtpResolutions PortalSubmissionOtp[] @relation("OtpResolvedBy")
  fundingApplicationDraft FundingApplicationDraft?
  subscriptions     Subscription[]
  invoices          Invoice[]
  // Brand OS relations
  brandDraftsAuthored BrandDraft[] @relation("BrandDraftAuthor")
  brandRoles          BrandRole[]
  brandComments       BrandComment[]
  brandApprovals      BrandApproval[]
  auditLogs           AuditLog[]
  portalSubmissions   PortalSubmission[]    @relation("SubmissionRequestedBy")
  documentGenerations DocumentGeneration[]

  @@index([email])
  @@index([role])
  @@index([status])
  @@index([createdAt])
}

model Startup {
  id                 Int                 @id @default(autoincrement())
  name               String
  slug               String              @unique
  description        String?
  stage              String?
  sector             String?
  location           String?
  dpiitNumber        String?             @unique
  foundingYear       Int?
  teamSize           Int?
  revenue            Float?
  revenueBand        String?
  servicesNeeded     String?
  specialCriteria    String?
  preferredBankTypes String?
  preferredLoanMin   Float?
  preferredLoanMax   Float?
  registeredAs       String?
  website            String?
  linkedin           String?
  userId             Int
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  autoApplyLogs      AutoApplyLog[]
  complianceRequests ComplianceRequest[]
  documents          Document[]
  portalSubmissions  PortalSubmission[]
  documentGenerations DocumentGeneration[]
  maListings         MAListing[]
  marketingRequests  MarketingRequest[]
  serviceRequests    ServiceRequest[]
  agencyRequests     AgencyRequest[]
  feedPosts          FeedPost[]
  feedFollowers      FeedFollow[]        @relation("FeedFollowTargetStartup")
  brandingSettings   BrandingSettings[]
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Brand OS relations
  brandTokens        BrandToken[]
  brandDrafts        BrandDraft[]
  brandVersions      BrandVersion[]
  brandAssets        BrandAsset[]
  brandRoles         BrandRole[]
  brandExportJobs    BrandExportJob[]

  @@index([slug])
  @@index([userId])
  @@index([stage])
  @@index([sector])
  @@index([createdAt])
}

model Document {
  id         Int       @id @default(autoincrement())
  startupId  Int
  name       String
  fileUrl    String
  type       String
  status     String    @default("pending")
  notes      String?
  templateKey String?
  format     String?   @default("pdf")
  version    Int?      @default(1)
  metadata   Json?
  sourceGenerationId Int?
  uploadedAt DateTime  @default(now())
  verifiedAt DateTime?
  startup    Startup   @relation(fields: [startupId], references: [id], onDelete: Cascade)
  sourceGeneration DocumentGeneration? @relation(fields: [sourceGenerationId], references: [id], onDelete: SetNull)

  @@index([startupId])
  @@index([type])
  @@index([status])
  @@index([uploadedAt])
}

model DocumentGeneration {
  id           Int      @id @default(autoincrement())
  startupId    Int
  createdById  Int?
  templateKey  String
  format       String   @default("pdf")
  version      Int      @default(1)
  status       String   @default("processing") // processing | completed | failed
  tone         String?  // friendly | formal | investor
  payload      Json?
  errorMessage String?
  documentId   Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  startup      Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)
  createdBy    User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)
  document     Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  @@index([startupId])
  @@index([createdById])
  @@index([templateKey])
  @@index([status])
}

model PortalSubmission {
  id                 Int       @id @default(autoincrement())
  startupId          Int
  requestedById      Int?
  portalKey          String
  status             String    @default("queued") // queued | running | submitted | failed | cancelled
  portalApplicationId String?
  receiptUrl         String?
  payload            Json?
  metadata           Json?
  lastError          String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  startup            Startup   @relation(fields: [startupId], references: [id], onDelete: Cascade)
  requestedBy        User?     @relation("SubmissionRequestedBy", fields: [requestedById], references: [id], onDelete: SetNull)
  logs               PortalSubmissionLog[]
  otpRequests        PortalSubmissionOtp[]

  @@index([startupId])
  @@index([requestedById])
  @@index([portalKey])
  @@index([status])
}

model PortalSubmissionLog {
  id            Int      @id @default(autoincrement())
  submissionId  Int
  level         String   @default("info")
  step          String?
  message       String
  context       Json?
  createdAt     DateTime @default(now())
  submission    PortalSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([level])
}

model PortalSubmissionOtp {
  id           Int      @id @default(autoincrement())
  submissionId Int
  channel      String   @default("sms")
  instructions String?
  context      Json?
  status       String   @default("pending") // pending | resolved | expired
  code         String?
  expiresAt    DateTime
  resolvedAt   DateTime?
  resolvedById Int?
  createdAt    DateTime @default(now())

  submission   PortalSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  resolvedBy   User?            @relation("OtpResolvedBy", fields: [resolvedById], references: [id], onDelete: SetNull)

  @@index([submissionId])
  @@index([status])
  @@index([expiresAt])
}

model GovtScheme {
  id                 Int       @id @default(autoincrement())
  schemeName         String    @unique
  ministry           String?
  department         String?
  category           String?
  benefitType        String?
  benefits           String?
  maxAssistance      String?
  amountRange        String?
  eligibility        String?
  sectors            String?
  region             String?
  applicationProcess String?
  officialLink       String?
  applicationLink    String?
  status             String?   @default("Active")
  description        String?
  criteria           String?
  deadline           DateTime?
  source             String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model State {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  abbreviation String?
  region       String?
  population   Int?
  gdp          Float?
  description  String?
  schemes      StateFundingScheme[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([name])
}

model StateFundingScheme {
  id              Int      @id @default(autoincrement())
  stateId         Int
  title           String
  description     String?
  fundingAmount   String?
  interestRate    Float?
  sector          String?
  subSector       String?
  eligibility     String?
  eligibilityJson String?
  applyLink       String?
  officialLink    String?
  centralOrState  String   @default("State")
  fundingType     String?
  fundingMin      Int?
  fundingMax      Int?
  subsidyPercent  Float?
  lastUpdated     DateTime @default(now())
  status          String   @default("Active")
  verified        Boolean  @default(false)
  popularityScore Int      @default(0)
  tags            String?

  state         State    @relation(fields: [stateId], references: [id], onDelete: Cascade)

  @@index([stateId])
  @@index([sector])
  @@index([fundingType])
  @@index([status])
}

model BankScheme {
  id                Int       @id @default(autoincrement())
  bankName          String
  schemeName        String
  type              String?   // government | private | venture_debt | overdraft | invoice_discount | working_capital
  minLoanAmount     Float?    // In rupees (keeping Float for compatibility)
  maxLoanAmount     Float?    // In rupees (keeping Float for compatibility)
  interestRate      String?   // e.g., "8-10%" or "Starting from 9%"
  tenure            String?   // e.g., "1-5 years"
  processingFees    String?
  eligibility       String?
  documentsRequired String?
  sectors           String?   // comma-separated list
  states            String?   // comma-separated list of states where available
  description       String?
  officialSource    String?
  status            String?   @default("Active") // Active | Inactive | Updated
  sourceFetchedAt   DateTime? // when this row was last fetched/updated automatically
  // Legacy fields (for backward compatibility)
  benefits          String?
  industry          String?   // Startup, MSME, FinTech, etc.
  state             String?   // Single state (deprecated, use states)
  region            String?   // National, North, South, etc.
  collateral        String?
  source            String?
  lastUpdatedBy     String?   // system | admin | cron
  updateNotes       String?
  officialLink      String?   // Legacy field
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Settings {
  id                Int       @id @default(autoincrement())
  key               String    @unique
  value             String?   // JSON string for complex values
  type              String    @default("string") // string | json | color | url
  category          String?   // branding | theme | general
  description       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// Optional dedicated branding settings (current app uses generic Settings with category='branding')
model BrandingSettings {
  id            Int      @id @default(autoincrement())
  startupId     Int?
  companyName   String?
  primaryColor  String?
  logoUrl       String?
  paletteJson   String?  // JSON string
  typography    String?
  status        String?  @default("in_progress") // in_progress | completed
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  startup       Startup? @relation(fields: [startupId], references: [id], onDelete: SetNull)
}

// === Brand OS models ===
model BrandToken {
  id         Int      @id @default(autoincrement())
  startupId  Int?
  tokensJson String   // normalized semantic tokens (colors/typography/spacing), JSON string
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  startup    Startup? @relation(fields: [startupId], references: [id], onDelete: SetNull)

  @@index([startupId])
}

model BrandDraft {
  id         Int      @id @default(autoincrement())
  startupId  Int?
  authorId   Int?
  dataJson   String   // full draft payload (tokens, assets selections, metadata)
  status     String   @default("draft") // draft | review | approved
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  startup    Startup? @relation(fields: [startupId], references: [id], onDelete: SetNull)
  author     User?    @relation("BrandDraftAuthor", fields: [authorId], references: [id], onDelete: SetNull)
  comments   BrandComment[]
  approvals  BrandApproval[]

  @@index([startupId])
  @@index([authorId])
  @@index([status])
}

model BrandVersion {
  id          Int      @id @default(autoincrement())
  startupId   Int?
  version     String
  dataJson    String   // frozen published payload (tokens + assets)
  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  startup     Startup? @relation(fields: [startupId], references: [id], onDelete: SetNull)
  assets      BrandAsset[]
  exports     BrandExportJob[]

  @@index([startupId])
  @@unique([startupId, version])
}

model BrandAsset {
  id          Int      @id @default(autoincrement())
  startupId   Int?
  versionId   Int?
  kind        String   // logo | favicon | app_icon | social_banner
  variant     String?  // default | mono | dark | light | twitter | linkedin etc.
  url         String
  width       Int?
  height      Int?
  format      String?  // svg | png | webp | ico
  createdAt   DateTime @default(now())

  startup     Startup?     @relation(fields: [startupId], references: [id], onDelete: SetNull)
  version     BrandVersion? @relation(fields: [versionId], references: [id], onDelete: SetNull)

  @@index([startupId])
  @@index([versionId])
  @@index([kind])
}

model BrandRole {
  id        Int      @id @default(autoincrement())
  startupId Int
  userId    Int
  role      String   // owner | designer | reviewer
  createdAt DateTime @default(now())

  startup   Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([startupId, userId])
  @@index([role])
}

model BrandComment {
  id        Int      @id @default(autoincrement())
  draftId   Int
  authorId  Int?
  text      String
  createdAt DateTime @default(now())

  draft     BrandDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)
  author    User?      @relation(fields: [authorId], references: [id], onDelete: SetNull)

  @@index([draftId])
  @@index([authorId])
}

model BrandApproval {
  id        Int      @id @default(autoincrement())
  draftId   Int
  approverId Int?
  status    String   @default("pending") // pending | approved | rejected
  note      String?
  createdAt DateTime @default(now())

  draft     BrandDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)
  approver  User?      @relation(fields: [approverId], references: [id], onDelete: SetNull)

  @@index([draftId])
  @@index([approverId])
  @@index([status])
}

model BrandExportJob {
  id         Int      @id @default(autoincrement())
  startupId  Int?
  versionId  Int?
  status     String   @default("queued") // queued | processing | completed | failed
  filesJson  String?  // list of files in the export
  url        String?  // final downloadable ZIP/PDF location
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  startup    Startup?     @relation(fields: [startupId], references: [id], onDelete: SetNull)
  version    BrandVersion? @relation(fields: [versionId], references: [id], onDelete: SetNull)

  @@index([startupId])
  @@index([versionId])
  @@index([status])
}
model FundingApplication {
  id                 Int       @id @default(autoincrement())
  userId             Int
  assignedReviewerId Int?
  status             String    @default("draft") // draft | submitted | in-review | approved | rejected
  progress           Int       @default(0)

  fullName           String
  email              String
  phone              String?
  city               String?
  state              String?

  startupName        String?
  website            String?
  socialLinks        String?   // JSON string or comma separated links
  industry           String?
  stage              String?

  problem            String?
  solution           String?
  targetAudience     String?

  revenue            String?
  profit             String?
  customers          String?
  fundingRaised      String?
  growthMetrics      String?

  amountRequested    Float?
  equityOffered      Float?
  useOfFunds         String?

  pitchVideoUrl      String?
  pitchDeckUrl       String?

  submittedAt        DateTime?
  reviewedAt         DateTime?
  reviewNotes        String?

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  user               User      @relation("ApplicantApplications", fields: [userId], references: [id], onDelete: Cascade)
  assignedReviewer   User?     @relation("ReviewerApplications", fields: [assignedReviewerId], references: [id], onDelete: SetNull)
  activities         FundingApplicationActivity[]

  @@index([userId])
  @@index([assignedReviewerId])
  @@index([status])
  @@index([industry])
  @@index([stage])
}

model FundingApplicationDraft {
  id        Int      @id @default(autoincrement())
  userId    Int
  data      String   // JSON string containing draft payload
  updatedAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
}

model FundingApplicationActivity {
  id            Int       @id @default(autoincrement())
  applicationId Int
  actorUserId   Int?
  activityType  String
  message       String?
  createdAt     DateTime  @default(now())

  application   FundingApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  actor         User?              @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([applicationId])
  @@index([actorUserId])
  @@index([activityType])
}

model FeedPost {
  id              Int               @id @default(autoincrement())
  authorUserId    Int
  startupId       Int?
  body            String?
  embedUrl        String?
  mediaType       String?
  mediaUrl        String?
  linkUrl         String?
  linkTitle       String?
  linkDescription String?
  linkImageUrl    String?
  template        String?           // funding | launch | hiring | milestone | general
  templateData    String?           // JSON string for template-specific data
  professional    Boolean          @default(false)
  tagList         String?
  stage           String?
  industry        String?
  location        String?
  visibility      String           @default("public")
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  author          User             @relation(fields: [authorUserId], references: [id], onDelete: Cascade)
  startup         Startup?         @relation(fields: [startupId], references: [id], onDelete: SetNull)

  media           FeedPostMedia[]
  tags            FeedPostTag[]
  interactions    FeedInteraction[]
  comments        FeedComment[]
  bookmarks       FeedBookmark[]
  notifications   FeedNotification[]
}

model FeedPostMedia {
  id           Int      @id @default(autoincrement())
  postId       Int
  type         String
  url          String
  thumbnailUrl String?

  post         FeedPost @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model FeedPostTag {
  postId Int
  tag    String

  post   FeedPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@id([postId, tag])
}

model FeedInteraction {
  id        Int       @id @default(autoincrement())
  postId    Int
  userId    Int
  type      String
  metadata  String?
  createdAt DateTime  @default(now())

  post      FeedPost  @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
  @@unique([postId, userId, type])
}

model FeedComment {
  id               Int            @id @default(autoincrement())
  postId           Int
  authorUserId     Int
  body             String
  parentCommentId  Int?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  post             FeedPost       @relation(fields: [postId], references: [id], onDelete: Cascade)
  author           User           @relation(fields: [authorUserId], references: [id], onDelete: Cascade)
  parent           FeedComment?   @relation("FeedCommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies          FeedComment[]  @relation("FeedCommentReplies")

  @@index([postId])
  @@index([parentCommentId])
}

model FeedFollow {
  id               Int        @id @default(autoincrement())
  followerUserId   Int
  targetUserId     Int?
  targetStartupId  Int?
  tag              String?
  createdAt        DateTime   @default(now())

  follower         User       @relation("FeedFollowFollower", fields: [followerUserId], references: [id], onDelete: Cascade)
  targetUser       User?      @relation("FeedFollowTargetUser", fields: [targetUserId], references: [id], onDelete: Cascade)
  targetStartup    Startup?   @relation("FeedFollowTargetStartup", fields: [targetStartupId], references: [id], onDelete: Cascade)

  @@index([targetUserId])
  @@index([targetStartupId])
  @@index([tag])
  @@unique([followerUserId, targetUserId, targetStartupId, tag])
}

model FeedBookmark {
  userId     Int
  postId     Int
  collection String?   @default("default") // default | funding | product | hiring | learnings
  createdAt  DateTime  @default(now())

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  post       FeedPost  @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@id([userId, postId])
  @@index([userId, collection])
}

model FounderProfile {
  id              Int      @id @default(autoincrement())
  firstName       String
  lastName        String
  company         String?
  role            String?
  skills          String?
  experience      String?
  location        String?
  linkedin        String?
  portfolio       String?
  availability    String?
  email           String?  @unique
  phone           String?
  education       String?
  specializations String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model FeedNotification {
  id        Int       @id @default(autoincrement())
  userId    Int
  postId    Int?
  type      String
  payload   String?
  readAt    DateTime?
  createdAt DateTime  @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      FeedPost? @relation(fields: [postId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([postId])
}

model FeedTopicPreference {
  id         Int      @id @default(autoincrement())
  userId     Int
  tags       String?
  stages     String?
  industries String?
  locations  String?

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Recently Funded Startups (M&A module)
model FundedStartup {
  id                    Int       @id @default(autoincrement())
  name                  String
  industry              String?
  location              String?
  companySize           String?
  website               String?
  fundingStage          String?
  fundingAmount         String?
  fundingAmountNumeric  Float?
  foundedYear           Int?
  description           String?
  logoUrl               String?
  founderName           String?
  founderEmail          String?
  founderLinkedIn       String?
  investors             String?
  contactInfo           String?
  sourceUrl             String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([industry])
  @@index([location])
  @@index([fundingStage])
  @@index([foundedYear])
}

model BrandingPartner {
  id            Int      @id @default(autoincrement())
  name          String
  type          String
  verified      Boolean  @default(false)
  portfolioUrl  String?
  website       String?
  contactEmail  String?
  phone         String?
  city          String?
  rating        Float?   @default(0)
  ratingCount   Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  bookings      BrandingPartnerBooking[]

  @@index([type])
  @@index([verified])
  @@index([city])
}

model BrandingPartnerBooking {
  id             Int      @id @default(autoincrement())
  partnerId      Int
  requesterId    Int?
  requesterName  String
  requesterEmail String
  requestNotes   String?
  status         String   @default("PENDING") // PENDING | CONFIRMED | CANCELLED | COMPLETED
  scheduledAt    DateTime?
  meetingLink    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  partner        BrandingPartner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([requesterEmail])
  @@index([status])
  @@index([scheduledAt])
}

model BrandingWorkspace {
  id           Int      @id @default(autoincrement())
  userId       Int?
  agencyId     Int?
  title        String?  @default("Untitled Brand Workspace")
  sections     String   // JSON string with parsed sections
  suggestions  String?  // JSON string with recommended next actions
  progress     Int      @default(0)
  status       String   @default("draft")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  uploads      BrandingUpload[]
  tasks        BrandingWorkspaceTask[]

  @@index([userId])
  @@index([agencyId])
  @@index([status])
}

model BrandingUpload {
  id           Int      @id @default(autoincrement())
  workspaceId  Int
  filename     String
  fileType     String
  fileSize     Int
  url          String
  parsed       Boolean  @default(false)
  metadata     String?
  createdAt    DateTime @default(now())

  workspace    BrandingWorkspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
}

model BrandingWorkspaceTask {
  id           Int      @id @default(autoincrement())
  workspaceId  Int
  title        String
  description  String?
  status       String   @default("pending")
  category     String?  // e.g. messaging, collateral, campaign
  aiGenerated  Boolean  @default(false)
  order        Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workspace    BrandingWorkspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([status])
}

model PitchDeck {
  id          Int      @id @default(autoincrement())
  title       String
  companyName String?
  stage       String?
  category    String?
  industry    String?
  source      String?
  fileUrl     String
  thumbnail   String?
  pages       Int?
  textExtract String?
  uploadedBy  Int?
  workspaceId Int?
  verified    Boolean  @default(false)
  year        Int?
  description String?
  tags        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AutoApplyLog {
  id         Int      @id @default(autoincrement())
  startupId  Int
  schemeId   Int
  schemeType String
  status     String   @default("pending")
  payload    String?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  startup    Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)
}

model DashboardStat {
  id        Int      @id @default(autoincrement())
  metric    String   @unique
  value     Int
  updatedAt DateTime @default(now())
}

model Subscription {
  id            Int       @id @default(autoincrement())
  userId        Int
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier          String    @default("freemium") // freemium | growth | scale | concierge
  billingCycle  String    @default("monthly") // monthly | annual
  razorpayId    String?   @unique
  status        String    @default("active") // active | cancelled | expired | trial
  startedAt     DateTime  @default(now())
  expiresAt     DateTime?
  cancelledAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  addOns        SubscriptionAddOn[]
  usageTracking UsageTracking[]
  invoices      Invoice[]
  
  @@index([userId])
  @@index([tier])
  @@index([status])
}

model SubscriptionAddOn {
  id             Int       @id @default(autoincrement())
  subscriptionId Int
  addOnType      String    // storage_10gb | extra_seat | auto_apply_workflow | ai_parsing_pages
  quantity       Int       @default(1)
  pricePerUnit   Float
  status         String    @default("active") // active | cancelled
  purchasedAt    DateTime  @default(now())
  expiresAt      DateTime?
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  @@index([subscriptionId])
  @@index([addOnType])
}

model UsageTracking {
  id             Int       @id @default(autoincrement())
  subscriptionId Int
  userId         Int
  startupId      Int?
  metricType     String    // auto_apply_workflows | ai_parsing_pages | storage_gb | partner_bookings | team_seats
  currentUsage   Int       @default(0)
  limit           Int?     // null means unlimited
  periodStart     DateTime  @default(now())
  periodEnd       DateTime?
  lastResetAt     DateTime  @default(now())
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  @@index([subscriptionId])
  @@index([userId])
  @@index([startupId])
  @@index([metricType])
  @@unique([subscriptionId, userId, metricType, periodStart])
}

model Invoice {
  id                Int       @id @default(autoincrement())
  subscriptionId    Int
  userId            Int
  invoiceNumber     String    @unique
  amount            Float
  currency          String    @default("INR")
  status            String    @default("pending") // pending | paid | failed | refunded
  razorpayOrderId   String?
  razorpayPaymentId String?
  items             String    // JSON string of invoice items
  taxAmount         Float     @default(0)
  discountAmount    Float     @default(0)
  totalAmount       Float
  dueDate           DateTime?
  paidAt            DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @default(now()) @updatedAt
  
  subscription      Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([invoiceNumber])
}

model Account {
  id                Int     @id @default(autoincrement())
  userId            Int
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           Int      @id @default(autoincrement())
  sessionToken String   @unique
  userId       Int
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int?
  title     String
  body      String
  link      String?
  level     String   @default("info")
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

// Branding/marketing contacts directory
model BrandingContact {
  id           Int       @id @default(autoincrement())
  organization String?
  firstName    String?
  lastName     String?
  designation  String?
  phone        String?
  email        String?   @unique
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([organization, firstName, lastName])
}

model Agency {
  id              Int               @id @default(autoincrement())
  name            String
  slug            String?           @unique
  location        String?
  city            String?
  state           String?
  country         String?           @default("India")
  logoUrl         String?
  bannerUrl       String?
  website         String?
  instagram       String?
  linkedin        String?
  youtube         String?
  twitter         String?
  contactEmail    String?
  contactPhone    String?
  services        String?           // JSON string or comma list
  description     String?
  rating          Float?            @default(4.0)
  minBudget       Int?              @default(5000)
  maxBudget       Int?
  currency        String?           @default("INR")
  portfolio       String?           // JSON string: list of {title,coverUrl,year}
  // legacy fields maintained for backward-compatibility
  category        String?
  portfolioUrls   String?
  verified        Boolean           @default(false)
  verifiedAt      DateTime?
  verifiedBy      String?
  featured        Boolean           @default(false)
  expertiseTags   String?
  industries      String?
  teamSize        Int?
  yearsExperience Int?
  responseTime    String?
  foundedYear     Int?
  employees       Int?
  categories      String?           // comma separated categories for quick filters
  serviceBadges   String?           // cached service badges for cards
  ratingCount     Int               @default(0)
  reviewCount     Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  proposals       AgencyProposal[]
  requests        AgencyRequest[]
  servicesOffered AgencyService[]
  portfolios      AgencyPortfolio[]
  reviews         AgencyReview[]
  leads           AgencyLead[]
  members         User[]            @relation("AgencyMembers")
  invitations     TeamInvitation[]

  @@index([city])
  @@index([state])
  @@index([verified])
  @@index([rating])
  @@index([minBudget])
  @@index([teamSize])
}

model AgencyService {
  id            Int      @id @default(autoincrement())
  agencyId      Int
  name          String
  category      String?
  description   String?
  deliveryType  String?  // project | retainer | hourly
  minTimeline   String?
  maxTimeline   String?
  startingPrice Int?
  currency      String?  @default("INR")
  isPrimary     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  agency        Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@unique([agencyId, name])
  @@index([agencyId])
}

model AgencyPortfolio {
  id           Int      @id @default(autoincrement())
  agencyId     Int
  title        String
  slug         String?  @unique
  description  String?
  mediaType    String?  // image | video | pdf | link
  mediaUrl     String
  thumbnailUrl String?
  caseStudyUrl String?
  clientName   String?
  industry     String?
  year         Int?
  tags         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  agency       Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@index([agencyId])
}

model AgencyReview {
  id             Int      @id @default(autoincrement())
  agencyId       Int
  authorName     String
  authorRole     String?
  company        String?
  projectType    String?
  rating         Int
  headline       String?
  comment        String?
  response       String?
  respondedAt    DateTime?
  status         String   @default("published") // published | flagged | hidden
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  agency         Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@index([rating])
}

model AgencyLead {
  id            Int      @id @default(autoincrement())
  agencyId      Int
  projectType   String
  projectScope  String?
  budgetMin     Int?
  budgetMax     Int?
  currency      String?  @default("INR")
  timeline      String?
  startDate     DateTime?
  description   String?
  contactName   String
  contactEmail  String
  contactPhone  String?
  companyName   String?
  designation   String?
  source        String?  @default("portal")
  status        String   @default("new") // new | contacted | in_progress | closed | rejected
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  agency        Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@index([status])
}

model TeamInvitation {
  id           Int      @id @default(autoincrement())
  email        String
  name         String?
  role         String   @default("VIEWER")
  agencyId     Int
  token        String   @unique
  tokenHash    String
  createdById  Int
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  acceptedAt   DateTime?
  acceptedById Int?
  status       String   @default("PENDING")
  metadata     String?

  agency       Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  createdBy    User     @relation("InvitesCreated", fields: [createdById], references: [id], onDelete: Cascade)
  acceptedBy   User?    @relation("InvitesAccepted", fields: [acceptedById], references: [id], onDelete: SetNull)

  @@index([email])
  @@unique([tokenHash])
}

model Investor {
  id         Int      @id @default(autoincrement())
  name       String
  firm       String?
  stageFocus String?
  sectors    String?
  location   String?
  email      String?
  linkedin   String?
  createdAt  DateTime @default(now())
}

model ServiceRequest {
  id                 Int      @id @default(autoincrement())
  startupId          Int
  serviceType        String
  documents          String?
  paymentStatus      String   @default("pending")
  registrationStatus String   @default("initiated")
  razorpayOrderId    String?  @unique
  razorpayPaymentId  String?
  amount             Float?
  adminNotes         String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  startup            Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)
}

model ComplianceRequest {
  id                Int       @id @default(autoincrement())
  startupId         Int
  complianceType    String
  category          String
  documents         String?
  paymentStatus     String    @default("pending")
  progressStatus    String    @default("initiated")
  razorpayOrderId   String?   @unique
  razorpayPaymentId String?
  amount            Float?
  deadline          DateTime?
  notes             String?
  certificateUrl    String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  startup           Startup   @relation(fields: [startupId], references: [id], onDelete: Cascade)
}

model MAListing {
  id              Int          @id @default(autoincrement())
  type            String
  startupId       Int?
  userId          Int
  title           String
  description     String?
  industry        String?
  location        String?
  stage           String?
  revenue         Int?
  profit          Int?
  users           Int?
  askingPrice     Int?
  budgetMin       Int?
  budgetMax       Int?
  teamSize        Int?
  assets          String?
  pitchDeckUrl    String?
  documents       String?
  whySelling      String?
  status          String       @default("active")
  isApproved      Boolean      @default(false)
  adminNotes      String?
  views           Int          @default(0)
  interestedUsers String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  dealRooms       MADealRoom[]
  startup         Startup?     @relation(fields: [startupId], references: [id])
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model MADealRoom {
  id         Int       @id @default(autoincrement())
  listingId  Int
  user1      Int
  user2      Int
  messages   String?
  dealStatus String    @default("negotiating")
  documents  String?
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  listing    MAListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
}

model MarketingRequest {
  id                Int              @id @default(autoincrement())
  userId            Int
  startupId         Int?
  serviceType       String
  description       String?
  budgetMin         Int?
  budgetMax         Int?
  preferredStyle    String?
  timeline          String?
  documents         String?
  status            String           @default("pending")
  assignedAgency    Int?
  razorpayOrderId   String?          @unique
  razorpayPaymentId String?
  paymentStatus     String           @default("pending")
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  proposals         AgencyProposal[]
  startup           Startup?         @relation(fields: [startupId], references: [id])
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AgencyProposal {
  id           Int              @id @default(autoincrement())
  requestId    Int
  agencyId     Int
  // New fields per spec
  startupId    Int?
  price        Int
  timeline     String
  proposalText String?
  files        String?
  // Legacy fields for compatibility
  message      String?
  deliverables String?
  workPlan     String?
  status       String           @default("pending")
  acceptedAt   DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  agency       Agency           @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  // Backward compatibility with MarketingRequest; new AgencyRequest relation uses agencyRequestId
  request      MarketingRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  agencyRequestId Int?
  agencyRequest AgencyRequest? @relation(fields: [agencyRequestId], references: [id])
}

// Direct startup â†’ agency request for proposals
model AgencyRequest {
  id                Int       @id @default(autoincrement())
  agencyId          Int
  startupId         Int
  serviceType       String
  budget            Int?
  timeline          String?
  message           String?
  files             String?
  status            String    @default("pending") // pending | proposal_sent | accepted | declined | closed
  brandingCompleted Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  agency            Agency    @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  startup           Startup   @relation(fields: [startupId], references: [id], onDelete: Cascade)
  proposals         AgencyProposal[]
  messages          AgencyMessage[]
}

// Chat-style messaging per request
model AgencyMessage {
  id         Int      @id @default(autoincrement())
  requestId  Int
  senderId   Int
  senderType String   // startup | agency
  message    String?
  files      String?
  readAt     DateTime?
  createdAt  DateTime @default(now())
  request    AgencyRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
}

// Startup Challenge Module
model Challenge {
  id                Int               @id @default(autoincrement())
  slug              String            @unique
  title             String
  shortDesc         String?
  longDesc          String?
  thematicAreas     String?           // comma list or JSON
  startAt           DateTime
  submissionDeadline DateTime
  firstEvalAt       DateTime?
  secondEvalAt      DateTime?
  status            String            @default("draft") // draft|open|closed|evaluating|completed
  incentives        String?
  eligibilityJson   String?           // JSON string
  evaluationJson    String?           // JSON string
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  submissions       Submission[]
  invites           ChallengeInvite[]
}

model Submission {
  id                Int      @id @default(autoincrement())
  challengeId       Int
  companyName       String
  founders          String?  // JSON string
  entityType        String?
  operationalSince  DateTime?
  stage             String?
  description       String?
  technicalProposal String?
  deckUrl           String?
  sampleUrls        String?  // JSON string
  financials        String?  // JSON string
  location          String?
  submittedAt       DateTime @default(now())
  status            String   @default("received") // received|shortlisted|rejected|finalist|winner
  rawScore          Float?
  reviewCount       Int      @default(0)
  meta              String?  // JSON string
  challenge         Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  reviews           Review[]
}

model Judge {
  id         Int      @id @default(autoincrement())
  name       String
  email      String   @unique
  bio        String?
  organisation String?
  createdAt  DateTime @default(now())
  reviews    Review[]
}

model Review {
  id           Int      @id @default(autoincrement())
  submissionId Int
  judgeId      Int
  scores       String   // JSON string
  totalScore   Float
  comments     String?
  submittedAt  DateTime @default(now())
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  judge        Judge @relation(fields: [judgeId], references: [id], onDelete: Cascade)
}

model ChallengeInvite {
  id         Int      @id @default(autoincrement())
  challengeId Int
  email      String
  token      String   @unique
  role       String   // applicant|judge|partner
  createdAt  DateTime @default(now())
  used       Boolean  @default(false)
  challenge  Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
}

// === Audit Log (Production Security) ===
model AuditLog {
  id          Int      @id @default(autoincrement())
  userId      Int?
  action      String   // login, profile_update, api_access, funding_submission, admin_action
  resourceType String? // User, Startup, FundingApplication, etc.
  resourceId  Int?
  ipAddress   String?
  userAgent   String?
  metadata    String?  // JSON string for additional context
  success     Boolean  @default(true)
  errorMessage String?
  createdAt   DateTime @default(now())

  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@index([success])
}
